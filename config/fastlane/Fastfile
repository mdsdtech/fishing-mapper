lane :ci_deploy do
  # App Store Connect API Key for authentication
  api_key = app_store_connect_api_key(
    key_id: ENV["APPSTORE_API_KEY_ID"],
    issuer_id: ENV["APPSTORE_API_ISSUER_ID"],
    key_filepath: "fastlane/AuthKey_#{ENV['APPSTORE_API_KEY_ID']}.p8",
    duration: 1200, # 20 minutes
    in_house: false
  )

  # Build with cloud-optimized settings
  build_app(
    workspace: "App/App.xcworkspace",
    scheme: "App",
    configuration: "Release",
    xcargs: {
      :DEVELOPMENT_TEAM => ENV['APPLE_TEAM_ID'],
    },
    allow_provisioning_updates: true, # Allow Fastlane to manage provisioning profiles
    export_method: "app-store",
    output_directory: "build"  # Faster git operations
  )

  # TestFlight upload with App Store Connect API Key
  upload_to_testflight(
    skip_waiting_for_build_processing: true,
    api_key: api_key,
    app_identifier: ENV["APP_BUNDLE_ID"]
  )
end